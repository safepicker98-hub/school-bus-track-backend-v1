generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

//////////////////////////////////////////////////////
// USER & AUTH
//////////////////////////////////////////////////////

model User {
  id        Int      @id @default(autoincrement())
  name      String?
  email     String   @unique
  password  String
  role      String // replaced enum UserRole with String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  authTokens AuthToken[]

  // Relations
  students         Student[]         @relation("ParentStudents")
  driverId         Int
  driver           Driver?
  notifications    Notification[]
  chatParticipants ChatParticipant[]
  messagesSent     Message[]
  posts            Post[]
  supportTickets   SupportTicket[]
}

model AuthToken {
  id        Int      @id @default(autoincrement())
  token     String
  userId    Int
  createdAt DateTime @default(now())
  expiresAt DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

//////////////////////////////////////////////////////
// STUDENTS & PARENTS
//////////////////////////////////////////////////////

model Student {
  id        Int      @id @default(autoincrement())
  name      String
  class     String?
  createdAt DateTime @default(now())

  parents     User[]       @relation("ParentStudents")
  stopId      Int?
  stop        Stop?        @relation(fields: [stopId], references: [id])
  attendances Attendance[]
  panics      Panic[]
}

//////////////////////////////////////////////////////
// DRIVER & BUS
//////////////////////////////////////////////////////

model Driver {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique
  licenseNo String
  phone     String?
  createdAt DateTime @default(now())

  user            User             @relation(fields: [userId], references: [id])
  trips           Trip[]
  buses           Bus[]
  driverBehaviors DriverBehavior[] // now linked properly
  panics          Panic[]
}

model Bus {
  id        Int      @id @default(autoincrement())
  name      String
  number    String
  capacity  Int
  createdAt DateTime @default(now())

  driverId Int?
  driver   Driver? @relation(fields: [driverId], references: [id])

  trips     Trip[]
  locations BusLocation[]
  etas      BusETA[]
  panics    Panic[]
}

//////////////////////////////////////////////////////
// ROUTES & STOPS
//////////////////////////////////////////////////////

model Route {
  id        Int      @id @default(autoincrement())
  name      String
  createdAt DateTime @default(now())

  stops Stop[]
  trips Trip[]
}

model Stop {
  id        Int    @id @default(autoincrement())
  name      String
  latitude  Float
  longitude Float
  order     Int

  routeId Int
  route   Route @relation(fields: [routeId], references: [id])

  students Student[]
  etas     BusETA[]
}

//////////////////////////////////////////////////////
// TRIPS
//////////////////////////////////////////////////////

model Trip {
  id        Int       @id @default(autoincrement())
  status    String // replaced enum TripStatus with String
  startedAt DateTime?
  endedAt   DateTime?
  createdAt DateTime  @default(now())

  busId    Int
  driverId Int
  routeId  Int

  bus    Bus    @relation(fields: [busId], references: [id])
  driver Driver @relation(fields: [driverId], references: [id])
  route  Route  @relation(fields: [routeId], references: [id])

  attendances     Attendance[]
  panics          Panic[]
  driverBehaviors DriverBehavior[]
}

//////////////////////////////////////////////////////
// BUS LOCATIONS & ETA
//////////////////////////////////////////////////////

model BusLocation {
  id        Int      @id @default(autoincrement())
  latitude  Float
  longitude Float
  speed     Float?
  heading   Float?
  createdAt DateTime @default(now())

  busId Int
  bus   Bus @relation(fields: [busId], references: [id])
}

model BusETA {
  id        Int      @id @default(autoincrement())
  busId     Int
  stopId    Int
  eta       Int
  createdAt DateTime @default(now())

  bus  Bus  @relation(fields: [busId], references: [id])
  stop Stop @relation(fields: [stopId], references: [id])
}

//////////////////////////////////////////////////////
// ATTENDANCE
//////////////////////////////////////////////////////

model Attendance {
  id        Int      @id @default(autoincrement())
  tripId    Int
  studentId Int
  type      String
  timestamp DateTime @default(now())

  trip    Trip    @relation(fields: [tripId], references: [id])
  student Student @relation(fields: [studentId], references: [id])
}

//////////////////////////////////////////////////////
// NOTIFICATIONS
//////////////////////////////////////////////////////

model Notification {
  id        Int      @id @default(autoincrement())
  title     String
  message   String
  type      String
  userId    Int?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])
}

//////////////////////////////////////////////////////
// CHAT
//////////////////////////////////////////////////////

model Chat {
  id           Int               @id @default(autoincrement())
  name         String?
  createdAt    DateTime          @default(now())
  messages     Message[]
  participants ChatParticipant[]
}

model ChatParticipant {
  id     Int @id @default(autoincrement())
  chatId Int
  userId Int

  chat Chat @relation(fields: [chatId], references: [id])
  user User @relation(fields: [userId], references: [id])
}

model Message {
  id        Int      @id @default(autoincrement())
  chatId    Int
  senderId  Int
  content   String
  createdAt DateTime @default(now())

  chat   Chat @relation(fields: [chatId], references: [id])
  sender User @relation(fields: [senderId], references: [id])
}

//////////////////////////////////////////////////////
// PANIC
//////////////////////////////////////////////////////

model Panic {
  id          Int       @id @default(autoincrement())
  tripId      Int?
  busId       Int?
  driverId    Int
  studentId   Int?
  description String?
  status      String    @default("active")
  createdAt   DateTime  @default(now())
  resolvedAt  DateTime?

  driver  Driver   @relation(fields: [driverId], references: [id])
  trip    Trip?    @relation(fields: [tripId], references: [id])
  student Student? @relation(fields: [studentId], references: [id])
  bus     Bus?     @relation(fields: [busId], references: [id])
}

//////////////////////////////////////////////////////
// DRIVER BEHAVIOR
//////////////////////////////////////////////////////

model DriverBehavior {
  id        Int      @id @default(autoincrement())
  driverId  Int
  tripId    Int?
  speed     Float?
  braking   Float?
  eventType String
  createdAt DateTime @default(now())

  driver Driver @relation(fields: [driverId], references: [id]) // now links to Driver
  trip   Trip?  @relation(fields: [tripId], references: [id])
}

model SystemLog {
  id        Int      @id @default(autoincrement())
  level     String // info | warn | error
  message   String
  meta      String?
  createdAt DateTime @default(now())
}

model SupportTicket {
  id        Int      @id @default(autoincrement())
  userId    Int?
  subject   String
  message   String
  status    String   @default("open")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User? @relation(fields: [userId], references: [id])
}

//////////////////////////////////////////////////////
// POSTS
//////////////////////////////////////////////////////

model Post {
  id        Int      @id @default(autoincrement())
  title     String
  content   String?
  published Boolean  @default(false)
  authorId  Int
  createdAt DateTime @default(now())

  author User @relation(fields: [authorId], references: [id])
}
